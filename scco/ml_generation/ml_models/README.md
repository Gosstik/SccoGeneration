### Общий концепт
Используется сберовская модель GigaChat'а: https://developers.sber.ru/docs/ru/gigachat/api/overview  
Что должно делаться в предобработчике идейно:
- отсеивать неподходящие сообщения с учетом white/black листов. Необходимо по сообщению понять: 
   - ищет ли человек хоть что-то
   - нужен ли ему конкретно наш продукт (то что нужно заказчику)
   - Приемлимо ли сообщения с точки зрения оскорбительных слов  
- обработка сообщения:
   - приведение к нормалиованному виду (пока что это lowercase)
   - удаление ненужных символов (смайлы и тп)
   - группировка для подачи в ml сразу клиента а не его сообщения отдельно

В ml-микросервисе, что должно быть технически:
- api для использование GigaChat'а
- удобная система чтобы подменять параметры (в конфигах все нужные параметры настраиваются)

Должно быть идейно: 
- Накрутить эвристики, которая в зависимости от таргетности сообщения (от того насколько нам подходит) предобрабатывает сообщение
- Подставить в промпт GigaChat'а текст пользователя и информацию о заказчике, чтобы сгенерить текст с описанием заказчика, который предварительно подходит клиенту

Все это реализовано таким образом: 
- поступает запрос с информацией о заказчике и клиенте (от клиента только message по сути важен для генерации пока что)  
- на основе информации о заказчике составляеся промпт с описанием компании, предоставляемых услуг и тп
- В зависимости от кол-ва совпвадений с white-list ом часть сообщения обрезается (если меньше порога, то полностью, иначе линейно до верзнего порога от нижнего) - это нужно чтобы бустить модель в сторону использования не сообщения а больше основного промпта зачказчика
- В конец сообщения заказчика прикручивается информация о заказчике (теги), предварительно кажется, что машинка должна считаем, что нужно упомянуть их.

### Описание реализации:
- gigachat_api_gate - тут содержаться вспомогательные вещи для удобного использования обертки, а также составления промпта, там же:
   - api.py - базовая версия обертки
   - gigachat_gate.py - тут идет обращение к GigaChat'у
   - token_update.py - используется для обновления токена доступа
- co_gen - содержит информацию для генерации, все эвристики и промпт для этого
- white_list_generation - содержит информацию и модель для генерации white-list'а на основе услуг (в будущем из customer-creator'а планировалось обращаться к ml-микросервису и добавить в основной white-list из тегов информацию отсюда)


### Использование
* Все модели располагаются в пакете `ml_models`.  
 Внутри в дирректориях co_gen, white_list_generation находятся готовые модели.  
 Для примера рассмотрим более сложную: co_gen
 В ml_models/gigachat_api_gate/api.py можно найти базовый класс всех моделей-оберток GigaChat'а  
 Чтобы создать свою модель надо:  
   1) Унаследовать свою модель от GenerateGateWrapper
   2) Переопределить generate - из request'а получает нужный ответ, в ней нужно:
      - вызвать ```self._set_system_params(request, make_system_prompt)```, где ```make_system_prompt``` берет pсистемный промпт (строку с описанием предназначения модели)
      - создать промпт, используя: ```self.system_prompt + ... ```  
         ```self.system_prompt``` создается сам, вам нужно добавить user-промпт, т.е. сообщение обрабатываемое. Рекомендуется просто передать необходимю строку в utils.UserMessageHandler как делается в co_gen.api
   3) Вызвать ```self.gate.generate_request(...)``` - от созданного выше промпта
   4) Результат можно обработать как делается в co_gen/api.py или так и оставить - там много ненужной информации, приходящей в запросе
   5) Также рекомендуется переопределить конструктор вашей обертки, где нужно прокринуть в родителя конкретный конфиг с параметрами

   Теперь нужно просто создать экземпляр обертки и вызвать метод generate(request), где в request обязательно должны быть поля, которые вы используете при создании системного промпта (в функции, которую передаете в self._set_system_params(request, ...))

- Общие рекомендации:  
   - Придерживаться неймингов авторов и все обертки оставлять в api.py
   - Конфиги все хранить в дирректориях с данными обертками и перегружать конструктор передавая конфиг в родителя
   - Если в конфиг должна попасть информация из request просто в промпте из конфига помечать мето и уже в функции ```make_system_prompt``` - которую передаете в ```self._set_system_params``` заменять все на нужные вам параметры

* Настройка конфигов: 
   - Единственный обязательный конфиг в вашей модели: configs/params.ini  
    тут по аналлогии с ml_models/co_gen/configs/params.ini нужно передать все те же параметры, но сменить параметры на нужные вам для данной модели
   - остальный конфиги, названия и параметры не столь принципиальны и использование оставляется на пользователя, рекомендуется придерживаться одного нейминга для базового промпта, пример см в ml_models/co_gen/configs/prompts.ini или в ml_models/white_list_generation/configs/prompts.ini и всю нужную для промптов общую информацию такж указывать в prompts.ini


#### Ошибки GigaChatа
При отправки запросов к GigaChat'у иногда возникают ошибки (очень часто из-за некорректных скретов). Все ошибки (коды у request) описаны тут:   
- https://developers.sber.ru/docs/ru/gigachat/api/reference-grpc

#### Параметры и настройка:
Параметры такие как и у любого GPT тоже смотреть тут:  
- https://developers.sber.ru/docs/ru/gigachat/api/reference-grpc


### Файлы с секретами
Файл `api_token.secret.env` по пути `scco/ml_generation/ml_models/src/ml_models/gigachat_api_gate/api_token.secret.env`
   Содержимое файла:
   ```bash
   GIGACHAT_API_SCOPE=<see below>
   GIGACHAT_API_CLIENT_ID=<see_below>
   GIGACHAT_API_CLIENT_SECRET=<see_below>
   ```
   Для получения значений `GIGACHAT_API_CLIENT_ID` и `GIGACHAT_API_CLIENT_SECRET` для физического лица нужно:
   0) Перейти на сайт [developers.sber.ru](https://developers.sber.ru/docs/ru/gigachat/individuals-quickstart)
   1) В правой части экрана нажать `подключить сервис` -> `начать пользоваться как физлицо`
   2) Зайти в аккаунт (например, по номеру телефона)
   3) В правой части экрана скопировать `Client ID` и вставить в переменную `GIGACHAT_API_CLIENT_ID`
   4) Нажать `Generate new` -> `Generate new one anyway`.
   5) Скопировать значение `Client Secret` в переменную `GIGACHAT_API_CLIENT_SECRET`
   **Note** Для юридических лиц инструкция немного другая, подробнее узнавайте на сайте (https://developers.sber.ru/docs/ru/gigachat/api/reference-grpc).

