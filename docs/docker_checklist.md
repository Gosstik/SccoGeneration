# Docker

<!--#########################################################################-->

## CLI

<!----------------------------------------------------------------------------->

### Docker state

#### Current docker state
```bash
docker info
```

#### Running containers
```bash
docker ps
docker ps -a # all containers (stopped, unused, etc.)
docker ps --format "table {{.ID}}\t{{.Names}}\t{{.Ports}}\t{{.Labels}}"
```

#### Installed images
```bash
docker images -a
```

#### Info about specific container
```bash
docker inspect <container_name>
```

#### History of level creation
```bash
docker history <image_name>
```

#### Help for command
```bash
docker <COMMAND> --help
```

<!----------------------------------------------------------------------------->

### Images

#### Internals
[Docker image layers](https://kodekloud.com/blog/docker-image-layers/).

#### Image creation
```bash
docker build -t [image-name] .
```
**NOTE**: `image-name` must be in `lower case`.


#### Docker registry
[Docker hub](hub.docker.com). Basic commands:
```bash
docker login
docker pull
docker push <username>/<image_name>:<tag>
docker push evashevich/rabbitmq:latest # example
```

<!----------------------------------------------------------------------------->

### Container creation

```bash
docker create 
```

**NOTE**: creation step can be omitted with `docker run` command.


<!----------------------------------------------------------------------------->

### Run

#### Run docker in `detach mode`
```bash
docker run -d -p 80:80 docker/hellow-world
```
- `-d` --- detached mode
- `-p <local>:<docker>` --- port forwarding. Port `<docker>` must be marked in `Dockerfile` with `EXPOSE`.

<!----------------------------------------------------------------------------->

### Interaction with created containers

```bash
docker start <container_name> # by default containers start in detached mode
docker stop <container_name>
docker pause <container_name>
docker unpause <container_name>
docker restart <container_name>
docker kill <container_name>
```

<!----------------------------------------------------------------------------->

### Interactive mode

#### Run container interactively
```bash
docker run -it --name <container_name> <image_name>
```

#### Start container interactively
```bash
docker start -i <container_name>
```

**NOTE**: Run is used only when container has not been created yet.

#### Connect to (enter inside) running container
```bash
docker exec -it <container_name> bash
```

**NOTE** When running `docker run -it ubuntu bash` the actual thing that gets executed is `/bin/sh -c bash`, where `/bin/sh -c` --- default value of `SHELL` (can be changed with `SHELL` command). 

<!----------------------------------------------------------------------------->

### Removing

[Great article](https://shisho.dev/blog/posts/docker-remove-cheatsheet/) about removing containers and images.

#### Remove images
```bash
docker image rm <image_name_or_id>
docker rmi <image_id> # short version
docker rmi -f <image_name> # force removal
docker image prune # remove stopped, unused and dangling images
docker image prune -a # remove only unused and dangling images
docker rmi $(docker images -f "dangling=true" -q) # remove only dangling images
docker rmi $(docker images -a -q) # remove all images
```

#### Remove containers
```bash
docker container prune # remove stopped and unused containers
docker run -rm image_name # -rm to remove container after stop
docker stop $(docker ps -a -q)
docker rm $(docker ps -a -q)
```

#### Remove all containers
```bash
docker system prune
docker system prune -a --filter "until = 24h"
```

### Logs
```bash
docker container logs <container_name>
```


<!--#########################################################################-->

## Dockerfile

<!----------------------------------------------------------------------------->

### Basics

Manual for basic commands in `Dockerfile`: [docker reference](https://docs.docker.com/reference/dockerfile/).

<!----------------------------------------------------------------------------->

### `ENTRYPOINT`, `CMD` and `SHELL`
- `ENTRYPOINT`: [link](https://docs.docker.com/reference/dockerfile/#entrypoint).
- `CMD`: [link](https://docs.docker.com/reference/dockerfile/#cmd)
- `SHELL`: [link](https://docs.docker.com/reference/dockerfile/#shell)
- `shell` and `exec` forms: [link](https://docs.docker.com/reference/dockerfile/#shell-and-exec-form).
- `shell` vs `exec` form:
  - `RUN`: **shell** form, because of the shell features (e.g. variable expansion $PATH, $HOME, piping, I/O redirection).
  - `ENTRYPOINT`: **exec** form, because of the signal trapping and forwarding (Most shells do not forward process signals to child processes, which means the SIGINT generated by pressing CTRL-C may not stop a child process).
  - `CMD`: **exec** form, the same reason.
- In case there are several `CMD` commands in `Dockerfile`, only the last one will be executed.
- In case you pass `COMMAND` to `docker run`, then this `COMMAND` will execute **each time** you run container with `docker start`.
- [How `CMD` and `ENTRYPOINT` interact (table)](https://docs.docker.com/reference/dockerfile/#understand-how-cmd-and-entrypoint-interact)

<!----------------------------------------------------------------------------->

### Difference between `ADD` and `COPY`

- `ADD` allows you to copy data from URL (`COPY` unable to do that).
  ```bash
  ADD [file-url] [destination]
  ```

- `ADD` automatically decompresses compressed files, while `COPY` copies them as-is.

<!----------------------------------------------------------------------------->

### Here-Documents

Dockerfile supports here-docs: [link](https://docs.docker.com/reference/dockerfile/#here-documents).

<!----------------------------------------------------------------------------->

### Custom bash

To make custom .bashrc inside docker for interactive modes we need to create /.bashrc in root. Then with `docker exec -it <container> bash` will open custom bash.

<!----------------------------------------------------------------------------->

### Environment variables (`.env` files)

- `.env` setup: [link](https://vsupalov.com/docker-arg-env-variable-guide/)

<!----------------------------------------------------------------------------->

<!--#########################################################################-->
<!--#########################################################################-->
<!--#########################################################################-->

# Docker-compose

<!--#########################################################################-->

## CLI

<!----------------------------------------------------------------------------->

### Basics

```bash
docker-compose build
docker-compose up
docker-compose down
docker-compose config # verify file syntax
```

**NOTE** no path to `docker-compose.yml` is specified (unlike in `docker` commands). But file can be manually specified with `-f` option between `docker-compose` and `COMMAND`. Example:
```bash
docker-compose -f <compose_file> up -d
docker-compose -f <compose_file> down
```

<!----------------------------------------------------------------------------->

### build

Show progress without new TUI (text user interface).
```bash
BUILDKIT_PROGRESS=plain docker-compose build 
docker-compose build --progress plain
```
The first command is universal, possible values of `BUILDKIT_PROGRESS`: auto|plain|tty.

### Don't use cache
```bash
docker-compose -f <compose_file> build --no-cache
```

<!----------------------------------------------------------------------------->

### up

Run several docker-compose (--project|-p) from the same directory:
```bash
docker-compose -p <project_name1> up -d # -d to run in detached mode
docker-compose -p <project_name2> up -d scale worker=2
```

Scaling:
```bash
docker-compose -p <project_name2> up --scale ML=10
```

<!----------------------------------------------------------------------------->

### Permanent restarting
[Link to stackoverflow](https://stackoverflow.com/questions/66638731/why-do-i-need-tty-true-in-docker-compose-yml-and-other-images-do-not)

<!--#########################################################################-->

## docker-compose.yml

Manual for basic commands in `docker-compose.yml`: [compose file reference](https://docs.docker.com/compose/compose-file/compose-file-v3/)

<!----------------------------------------------------------------------------->

### `entrypoint`

- `entrypoint` in docker-compose **overrides** entrypoint from dockerfile
```docker-compose
entrypoint: ["/bin/sh", "-c"] # default entrypoint
entrypoint: [ "sh", "-c", "echo $HOME" ] # adding shell to make variable expansion
entrypoint: echo $HOME # shell form of entrypoint (SHELL is used to do the command)
```

<!----------------------------------------------------------------------------->

### Environment variables

- [Rules](https://docs.docker.com/compose/compose-file/compose-file-v3/#variable-substitution) of variable substitution.
- [List](https://docs.docker.com/compose/environment-variables/envvars/) of predefined environment variables (in particular, `COMPOSE_PROJECT_NAME` and `COMPOSE_FILE` are used in `.env` files in our project).
- Environment files (e.g. `.env`) [structure](https://docs.docker.com/compose/environment-variables/env-file/).
- There are two ways in docker-compose to declare environment variables with `environment` section:
  - Way 1
  ```text
  services
    some_service:
      environment:
        ENV_VAR: ${VAR_VALUE}
  ```
  - Way 2 (allows to make variable expansion for `ENV_VAR`)
  ```text
  services
    some_service:
      environment:
        - ENV_VAR=${VAR_VALUE}
  ```

<!----------------------------------------------------------------------------->

### Docker-compose networks

- [Official guide](https://docs.docker.com/compose/networking/).

- To make `some-service` visible to other services in the same network, we have to declare network alias for that service. 
```text
services:
  some-service:
    networks:
      some-network:
        aliases:
          - alias1
          - alias2
```
[More about aliases][docs](https://docs.docker.com/compose/compose-file/compose-file-v3/#aliases) in official docs.

> NOTE!
> 
> A network-wide alias can be shared by multiple containers, and even by multiple services. If it is, then exactly which container the name resolves to is not guaranteed.

Code above allows us to write `requests.post(url=alias1)` to connect to `some-service` from another one. In our project we have to connect that way to RabbitMQ (but using `pika` library for `AMQP` protocol connection on python).

Before people use `hostname` key-word in docker-compose to make alias for service, but it is a bad practice and does not always work. 

<!----------------------------------------------------------------------------->

### tty

`tty: true` in service declaration is required only in those cases when we want **inside** (does not affect on simple `interactive shell`) the container to run `interactive shell` (see more on [stackoverflow](https://stackoverflow.com/questions/66638731/why-do-i-need-tty-true-in-docker-compose-yml-and-other-images-do-not))

<!----------------------------------------------------------------------------->

### Healthcheck

- [Control startup order](https://docs.docker.com/compose/startup-order/) of docker-compose cervices.
- Example of `healthcheck` in `docker-compose.yml` from official documentation:
  ```text
  services:
    <first_service>:
      healthcheck:
        test: ["CMD", "curl", "-f", "http://localhost"]
        interval: 1m30s
        timeout: 10s
        retries: 3
        start_period: 2m
  ```
  [Explanation](https://docs.docker.com/compose/compose-file/compose-file-v3/#healthcheck) of example.

- Example of `depends_on` from that project:
  ```text
  services:
    <second_service>:
      depends_on:
        <first_service>:
          condition: service_healthy # 'service_started' (default) or 'service_completed_successfully'
  ```

`Healthcheck` command for `RabbitMQ`:
```bash
rabbitmq-diagnostics check_port_connectivity # see docker-compose.yml in 'outside' folder
```
Related question on [stackoverflow](https://devops.stackexchange.com/a/15410/44741).


<!--#########################################################################-->
<!--#########################################################################-->
<!--#########################################################################-->

# RabbitMQ


Good guides on working with RabbitMQ, along with examples, are located on their website in the [tutorial section](https://www.rabbitmq.com/tutorials).

Default **login** and **password**: `guest`, `guest`.

### List of queues
```bash
sudo rabbitmqctl list_queues
```

For interaction through `AMQP` (default message protocol of RabbitMQ) one may use `pika` in python ([docs](https://pika.readthedocs.io/en/stable/intro.html)). 

<!--#########################################################################-->
<!--#########################################################################-->
<!--#########################################################################-->

# Current project (SCCO)

<!----------------------------------------------------------------------------->

### Removing related images
```bash
docker-compose rm -f
docker ps -a | grep rabbit | awk '{print $1}' | xargs docker rm
docker images -a | grep rabbit | awk '{print $3}' | xargs docker rmi -f
```

<!--#########################################################################-->
<!--#########################################################################-->
<!--#########################################################################-->

# Custom

- [Great docker cheat-sheet](https://shisho.dev/blog/posts/docker-remove-cheatsheet/).

- Verify port connection from python: [link](https://stackoverflow.com/questions/19196105/how-to-check-if-a-network-port-is-open).
```python
import socket
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
result = sock.connect_ex(('127.0.0.1',5672))
result
```
- Socket communication in python: [link](https://realpython.com/python-sockets/).
- Check port usage:
    ```bash
    lsof -i -P -n # return pid with app name (the most convenient)
    fuser 7000/tcp # get PID if process
    netstat # does not give pid process
    ```
